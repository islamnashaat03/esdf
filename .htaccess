# ===========================================
# WordPress Security-Hardened .htaccess
# ===========================================

# BEGIN WordPress
<IfModule mod_rewrite.c>
RewriteEngine On
RewriteRule .* - [E=HTTP_AUTHORIZATION:%{HTTP:Authorization}]
RewriteBase /
RewriteRule ^index\.php$ - [L]
RewriteCond %{REQUEST_FILENAME} !-f
RewriteCond %{REQUEST_FILENAME} !-d
RewriteRule . /index.php [L]
</IfModule>
# END WordPress

# ===========================================
# SECURITY RULES
# ===========================================

# -------------------------------------------
# Protect wp-config.php
# -------------------------------------------
<Files wp-config.php>
    Order Allow,Deny
    Deny from all
</Files>

# -------------------------------------------
# Protect .htaccess itself
# -------------------------------------------
<Files .htaccess>
    Order Allow,Deny
    Deny from all
</Files>

# -------------------------------------------
# Block access to sensitive files
# -------------------------------------------
<FilesMatch "^(wp-config\.php|readme\.html|license\.txt|debug\.log|error_log|\.git|\.gitignore|\.htaccess\.bak)">
    Order Allow,Deny
    Deny from all
</FilesMatch>

# -------------------------------------------
# Disable directory browsing
# -------------------------------------------
Options -Indexes

# -------------------------------------------
# Block access to .git directory
# -------------------------------------------
RedirectMatch 404 /\.git

# -------------------------------------------
# Protect wp-includes
# -------------------------------------------
<IfModule mod_rewrite.c>
    RewriteEngine On
    RewriteBase /
    RewriteRule ^wp-admin/includes/ - [F,L]
    RewriteRule !^wp-includes/ - [S=3]
    RewriteRule ^wp-includes/[^/]+\.php$ - [F,L]
    RewriteRule ^wp-includes/js/tinymce/langs/.+\.php - [F,L]
    RewriteRule ^wp-includes/theme-compat/ - [F,L]
</IfModule>

# -------------------------------------------
# Disable XML-RPC (Common attack vector)
# -------------------------------------------
<Files xmlrpc.php>
    Order Deny,Allow
    Deny from all
</Files>

# -------------------------------------------
# Block PHP execution in uploads
# -------------------------------------------
<IfModule mod_rewrite.c>
    RewriteRule ^wp-content/uploads/.*\.php$ - [F,L]
</IfModule>

# -------------------------------------------
# Prevent script injection
# -------------------------------------------
<IfModule mod_rewrite.c>
    RewriteCond %{QUERY_STRING} (<|%3C).*script.*(>|%3E) [NC,OR]
    RewriteCond %{QUERY_STRING} GLOBALS(=|\[|\%[0-9A-Z]{0,2}) [OR]
    RewriteCond %{QUERY_STRING} _REQUEST(=|\[|\%[0-9A-Z]{0,2})
    RewriteRule ^(.*)$ index.php [F,L]
</IfModule>

# -------------------------------------------
# Block suspicious user agents
# -------------------------------------------
<IfModule mod_rewrite.c>
    RewriteCond %{HTTP_USER_AGENT} (libwww-perl|wget|python|nikto|curl|scan|java|winhttp|clshttp|loader) [NC,OR]
    RewriteCond %{HTTP_USER_AGENT} (<|>|'|%0A|%0D|%27|%3C|%3E|%00) [NC,OR]
    RewriteCond %{HTTP_USER_AGENT} (;|<|>|'|"|\)|\(|%0A|%0D|%22|%27|%28|%3C|%3E|%00).*(libwww-perl|wget|python|nikto|curl|scan|java|winhttp|HTTrack|clshttp|archiver|loader|email|harvest|extract|grab|miner) [NC]
    RewriteRule ^(.*)$ - [F,L]
</IfModule>

# -------------------------------------------
# Security Headers
# -------------------------------------------
<IfModule mod_headers.c>
    # Prevent clickjacking
    Header always set X-Frame-Options "SAMEORIGIN"
    
    # Prevent MIME type sniffing
    Header always set X-Content-Type-Options "nosniff"
    
    # Enable XSS filter
    Header always set X-XSS-Protection "1; mode=block"
    
    # Referrer Policy
    Header always set Referrer-Policy "strict-origin-when-cross-origin"
    
    # Remove server signature
    Header unset Server
    Header always unset X-Powered-By
    
    # Permissions Policy
    Header always set Permissions-Policy "geolocation=(), microphone=(), camera=()"
</IfModule>

# -------------------------------------------
# Prevent hotlinking
# -------------------------------------------
<IfModule mod_rewrite.c>
    RewriteCond %{HTTP_REFERER} !^$
    RewriteCond %{HTTP_REFERER} !^https?://(www\.)?esdf-eg\.com [NC]
    RewriteRule \.(jpg|jpeg|png|gif|webp|svg)$ - [F,NC,L]
</IfModule>

# -------------------------------------------
# Force HTTPS
# -------------------------------------------
<IfModule mod_rewrite.c>
    RewriteCond %{HTTPS} !=on
    RewriteRule ^(.*)$ https://%{HTTP_HOST}/$1 [R=301,L]
</IfModule>

# -------------------------------------------
# Block access to sensitive directories
# -------------------------------------------
<IfModule mod_rewrite.c>
    RewriteRule ^wp-content/debug\.log - [F,L]
</IfModule>

# -------------------------------------------
# Limit file upload size (10MB)
# -------------------------------------------
LimitRequestBody 10485760
